<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ—¥æœŸå€’è®¡æ—¶</title>
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="å€’è®¡æ—¶">
  <!-- Android Chrome PWA ä¼˜åŒ– -->
  <meta name="mobile-web-app-capable" content="yes">
  <!-- Vant 4 CSS -->
  <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/vant@4/lib/index.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      min-height: 100vh;
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      padding: 20px;
    }

    .container {
      width: 100%;
      min-height: 100vh;
      padding: 10px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
    }

    .title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .result-card {
      margin-top: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      color: white;
      text-align: center;
      animation: fadeIn 0.5s ease;
    }

    .result-title {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }

    .result-days {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .result-date {
      font-size: 14px;
      opacity: 0.9;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .vant-field {
      border-radius: 10px;
      overflow: hidden;
    }

    .vant-field .van-field__control {
      font-size: 24px;
      color: #5557d5;
      font-weight: 500;
    }

    .vant-field .van-field__control::placeholder {
      color: #999;
      font-size: 16px;
    }

    .install-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 25px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .install-button:active {
      transform: scale(0.95);
    }

    /* éšè—å®‰è£…æŒ‰é’® */
    .install-button.hidden {
      display: none;
    }

  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <h1 class="title">ğŸ“… æ—¥æœŸå€’è®¡æ—¶</h1>

      <div class="form-group">
        <span class="label">é€‰æ‹©æ—¥æœŸ</span>
        <van-field
          v-model="selectedDate"
          readonly
          clickable
          placeholder="è¯·é€‰æ‹©æ—¥æœŸ"
          @click="openCalendar"
          class="vant-field"
        />
      </div>

      <div class="result-card" v-if="result !== null">
        <div class="result-title">è·ç¦» {{ resultDate }} è¿˜æœ‰</div>
        <div class="result-days">{{ result }} å¤©</div>
        <div class="result-date">ç›®æ ‡æ—¥æœŸ: {{ resultDate }}</div>
      </div>

      <!-- æ—¥å†å¼¹å‡ºå±‚ -->
      <van-calendar
        v-model:show="showCalendar"
        @confirm="onConfirm"
        :min-date="minDate"
        :max-date="maxDate"
        color="#764ba2"
      />
    </div>

    <!-- å®‰è£…æŒ‰é’® -->
    <button id="installButton" class="install-button hidden" onclick="installApp()">
      <span>ğŸ“²</span>
      <span>å®‰è£…åº”ç”¨</span>
    </button>
  </div>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Vant 4 JS -->
  <script src="https://fastly.jsdelivr.net/npm/vant@4/lib/vant.min.js"></script>
  <!-- å†œå†è®¡ç®—åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>

  <script>
    const { createApp, ref, computed, onMounted } = Vue;

    const app = createApp({
      setup() {
        const showCalendar = ref(false);
        const selectedDate = ref('');
        const result = ref(null);
        const resultDate = ref('');
        const minDate = ref(new Date(2020, 0, 1));
        const maxDate = ref(new Date(2030, 11, 31));

        // è®¡ç®—ä¸‹ä¸€ä¸ªå†œå†å¤§å¹´åˆä¸€
        const getNextLunarNewYear = () => {
          const today = new Date();
          const year = today.getFullYear();
          const month = today.getMonth() + 1;
          const day = today.getDate();

          // å†œå†æ–°å¹´æ—¥æœŸè¡¨ï¼ˆæŒ‰å¹´ä»½ï¼‰
          const lunarNewYearDates = {
            2025: { year: 2025, month: 1, day: 29 },  // 2025å¹´æ˜¥èŠ‚
            2026: { year: 2026, month: 2, day: 17 },  // 2026å¹´æ˜¥èŠ‚
            2027: { year: 2027, month: 2, day: 6 },   // 2027å¹´æ˜¥èŠ‚
            2028: { year: 2028, month: 1, day: 26 },  // 2028å¹´æ˜¥èŠ‚
            2029: { year: 2029, month: 2, day: 13 },  // 2029å¹´æ˜¥èŠ‚
            2030: { year: 2030, month: 2, day: 3 }    // 2030å¹´æ˜¥èŠ‚
          };

          // æ£€æŸ¥ä»Šå¹´çš„æ˜¥èŠ‚æ˜¯å¦å·²ç»è¿‡å»
          const thisYearSpringFestival = lunarNewYearDates[year];

          if (thisYearSpringFestival) {
            const springFestivalDate = new Date(
              thisYearSpringFestival.year,
              thisYearSpringFestival.month - 1,
              thisYearSpringFestival.day
            );

            // å¦‚æœä»Šå¹´çš„æ˜¥èŠ‚è¿˜æ²¡åˆ°ï¼Œè¿”å›ä»Šå¹´çš„æ˜¥èŠ‚
            if (today < springFestivalDate) {
              return thisYearSpringFestival;
            }
          }

          // ä»Šå¹´çš„æ˜¥èŠ‚å·²ç»è¿‡äº†ï¼Œè¿”å›æ˜å¹´çš„æ˜¥èŠ‚
          const nextYear = year + 1;
          if (lunarNewYearDates[nextYear]) {
            return lunarNewYearDates[nextYear];
          }

          // å¦‚æœæ²¡æœ‰é¢„å®šä¹‰ï¼Œä½¿ç”¨é»˜è®¤ä¼°ç®—ï¼ˆæ˜å¹´2æœˆä¸­æ—¬ï¼‰
          return { year: nextYear, month: 2, day: 15 };
        };

        // æ ¼å¼åŒ–æ—¥æœŸ
        const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };

        // ç¡®è®¤æ—¥æœŸé€‰æ‹©
        const onConfirm = (date) => {
          selectedDate.value = formatDate(date);
          showCalendar.value = false;
          // é€‰æ‹©æ—¥æœŸåè‡ªåŠ¨è®¡ç®—
          calculateDays();
        };

        // æ‰“å¼€æ—¥å†
        const openCalendar = () => {
          showCalendar.value = true;
        };

        // è®¡ç®—å‰©ä½™å¤©æ•°
        const calculateDays = () => {
          if (!selectedDate.value) {
            return;
          }

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          const target = new Date(selectedDate.value);
          target.setHours(0, 0, 0, 0);

          const diffTime = target - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          result.value = diffDays;
          resultDate.value = selectedDate.value;
        };

        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜å¹´å†œå†å¤§å¹´åˆä¸€
        onMounted(() => {
          const nextLunarNewYear = getNextLunarNewYear();
          const defaultDate = new Date(nextLunarNewYear.year, nextLunarNewYear.month - 1, nextLunarNewYear.day);
          selectedDate.value = formatDate(defaultDate);
          // é¡µé¢åŠ è½½åè‡ªåŠ¨è®¡ç®—
          calculateDays();
        });

        return {
          showCalendar,
          selectedDate,
          result,
          resultDate,
          minDate,
          maxDate,
          onConfirm,
          openCalendar,
        };
      }
    });

    // æ³¨å†Œ Vant ç»„ä»¶
    app.use(vant);

    // æŒ‚è½½åº”ç”¨
    app.mount('#app');

    // æ³¨å†Œ Service Worker (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ:', registration.scope);
          })
          .catch(error => {
            console.log('ServiceWorker æ³¨å†Œå¤±è´¥:', error);
          });
      });
    }

    // PWA å®‰è£…æç¤ºé€»è¾‘
    let deferredPrompt;
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
      // é˜»æ­¢é»˜è®¤çš„å®‰è£…æç¤º
      e.preventDefault();
      // ä¿å­˜äº‹ä»¶ä»¥ä¾¿åç»­è§¦å‘
      deferredPrompt = e;
      // æ˜¾ç¤ºå®‰è£…æŒ‰é’®
      installButton.classList.remove('hidden');
      console.log('PWA å®‰è£…äº‹ä»¶å·²è§¦å‘');
    });

    // å®‰è£…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    window.installApp = async () => {
      if (deferredPrompt) {
        // æ˜¾ç¤ºå®‰è£…æç¤º
        deferredPrompt.prompt();
        // ç­‰å¾…ç”¨æˆ·å“åº”
        const { outcome } = await deferredPrompt.userChoice;
        console.log(`ç”¨æˆ·${outcome === 'accepted' ? 'æ¥å—' : 'æ‹’ç»'}äº†å®‰è£…`);
        // æ¸…é™¤ deferredPrompt
        deferredPrompt = null;
        // éšè—å®‰è£…æŒ‰é’®
        installButton.classList.add('hidden');
      }
    };

    // æ£€æµ‹åº”ç”¨æ˜¯å¦å·²å®‰è£…
    window.addEventListener('appinstalled', () => {
      // åº”ç”¨å·²å®‰è£…ï¼Œéšè—å®‰è£…æŒ‰é’®
      installButton.classList.add('hidden');
      console.log('PWA å·²å®‰è£…');
      vant.showToast({
        message: 'å®‰è£…æˆåŠŸï¼',
        icon: 'success',
      });
    });

    // é¡µé¢åŠ è½½åæ£€æŸ¥æ˜¯å¦å¯ä»¥å®‰è£…
    window.addEventListener('load', () => {
      // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç‹¬ç«‹æ¨¡å¼ä¸‹è¿è¡Œï¼ˆå·²å®‰è£…ï¼‰
      if (window.matchMedia('(display-mode: standalone)').matches) {
        console.log('åº”ç”¨æ­£åœ¨ä»¥ç‹¬ç«‹æ¨¡å¼è¿è¡Œ');
      } else {
        console.log('åº”ç”¨æœªå®‰è£…ï¼Œç­‰å¾… beforeinstallprompt äº‹ä»¶');
      }
    });
  </script>
</body>
</html>
